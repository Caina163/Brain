{% extends "base.html" %}

{% block title %}Editar Quiz - {{ quiz.title }}{% endblock %}

{% block extra_head %}
<style>
.quiz-edit-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.quiz-steps {
    display: flex;
    margin-bottom: 30px;
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.step {
    flex: 1;
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.step.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.step h3 {
    margin: 0 0 5px 0;
    font-size: 16px;
}

.step p {
    margin: 0;
    font-size: 12px;
    opacity: 0.8;
}

.quiz-content {
    display: none;
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.quiz-content.active {
    display: block;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    color: #333;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.question-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    position: relative;
}

.question-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.question-number {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 14px;
}

.question-actions {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.question-text {
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
}

.question-image {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    margin: 10px 0;
}

.answer-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.answer-option {
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
}

.answer-correct {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.answer-incorrect {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.add-question-form {
    background: #e8f4fd;
    border: 2px dashed #4facfe;
    border-radius: 12px;
    padding: 25px;
    margin-top: 20px;
}

.file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
}

.file-input-wrapper input[type=file] {
    position: absolute;
    left: -9999px;
}

.file-input-label {
    padding: 10px 20px;
    background: #f8f9fa;
    border: 2px dashed #6c757d;
    border-radius: 8px;
    cursor: pointer;
    display: block;
    text-align: center;
    transition: all 0.3s ease;
}

.file-input-label:hover {
    background: #e9ecef;
    border-color: #495057;
}

.preview-image {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    margin: 10px 0;
    display: none;
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #b6d7ff;
    color: #0c5460;
}

.empty-questions {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.navigation-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}
</style>
{% endblock %}

{% block content %}
<div class="quiz-edit-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" style="margin-bottom: 20px;">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('quiz.manage') }}">Gerenciar Quizzes</a></li>
            <li class="breadcrumb-item active">Editar Quiz</li>
        </ol>
    </nav>

    <!-- Etapas -->
    <div class="quiz-steps">
        <div class="step active" id="step-info">
            <h3>1. Informa√ß√µes do Quiz</h3>
            <p>T√≠tulo, descri√ß√£o e imagem</p>
        </div>
        <div class="step" id="step-questions">
            <h3>2. Quest√µes</h3>
            <p>Adicionar e gerenciar quest√µes</p>
        </div>
    </div>

    <!-- Conte√∫do - Informa√ß√µes do Quiz -->
    <div class="quiz-content active" id="content-info">
        <h2>üìù Informa√ß√µes do Quiz</h2>
        
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="update_quiz">
            
            <div class="form-group">
                <label for="title">T√≠tulo do Quiz *</label>
                <input type="text" class="form-control" id="title" name="title" 
                       value="{{ quiz.title }}" required minlength="3">
            </div>
            
            <div class="form-group">
                <label for="description">Descri√ß√£o (opcional)</label>
                <textarea class="form-control" id="description" name="description" 
                          rows="3">{{ quiz.description or '' }}</textarea>
            </div>
            
            <div class="form-group">
                <label>Imagem do Quiz (opcional)</label>
                {% if quiz.image_filename %}
                    <div style="margin-bottom: 10px;">
                        <img src="{{ url_for('static', filename='uploads/' + quiz.image_filename) }}" 
                             alt="Imagem atual" class="question-image">
                        <p><small>Imagem atual. Selecione uma nova para substituir.</small></p>
                    </div>
                {% endif %}
                <div class="file-input-wrapper">
                    <input type="file" id="quiz_image" name="quiz_image" accept="image/*">
                    <label for="quiz_image" class="file-input-label">
                        üì∑ Clique para selecionar imagem
                    </label>
                </div>
                <img id="quiz-preview" class="preview-image">
            </div>
            
            <button type="submit" class="btn btn-primary">
                üíæ Salvar Informa√ß√µes
            </button>
        </form>
    </div>

    <!-- Conte√∫do - Quest√µes -->
    <div class="quiz-content" id="content-questions">
        <h2>‚ùì Quest√µes do Quiz ({{ quiz.questions|length }})</h2>
        
        <!-- Lista de Quest√µes Existentes -->
        {% if quiz.questions %}
            {% for question in quiz.questions|sort(attribute='order_index') %}
            <div class="question-card">
                <div class="question-header">
                    <span class="question-number">Quest√£o {{ loop.index }}</span>
                    <div class="question-actions">
                        {% if not loop.first %}
                        <button type="button" class="btn btn-sm btn-warning" 
                                onclick="moveQuestion({{ question.id }}, 'up')">
                            ‚¨ÜÔ∏è Subir
                        </button>
                        {% endif %}
                        {% if not loop.last %}
                        <button type="button" class="btn btn-sm btn-warning" 
                                onclick="moveQuestion({{ question.id }}, 'down')">
                            ‚¨áÔ∏è Descer
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-danger" 
                                onclick="confirmDeleteQuestion({{ question.id }}, '{{ question.question_text[:50] }}...')">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                </div>
                
                {% if question.image_filename %}
                <img src="{{ url_for('static', filename='uploads/' + question.image_filename) }}" 
                     alt="Imagem da quest√£o" class="question-image">
                {% endif %}
                
                <div class="question-text">{{ question.question_text }}</div>
                
                <div class="answer-options">
                    <div class="answer-option answer-correct">
                        ‚úÖ {{ question.correct_answer }}
                    </div>
                    {% if question.option_a %}
                    <div class="answer-option answer-incorrect">
                        ‚ùå {{ question.option_a }}
                    </div>
                    {% endif %}
                    {% if question.option_b %}
                    <div class="answer-option answer-incorrect">
                        ‚ùå {{ question.option_b }}
                    </div>
                    {% endif %}
                    {% if question.option_c %}
                    <div class="answer-option answer-incorrect">
                        ‚ùå {{ question.option_c }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-questions">
                <h3>üìù Nenhuma quest√£o adicionada ainda</h3>
                <p>Use o formul√°rio abaixo para adicionar a primeira quest√£o ao seu quiz.</p>
            </div>
        {% endif %}

        <!-- Formul√°rio para Adicionar Nova Quest√£o -->
        <div class="add-question-form">
            <h3>‚ûï Adicionar Nova Quest√£o</h3>
            
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="action" value="add_question">
                
                <div class="form-group">
                    <label>Imagem da Quest√£o (opcional)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="question_image" name="question_image" accept="image/*">
                        <label for="question_image" class="file-input-label">
                            üì∑ Clique para selecionar imagem
                        </label>
                    </div>
                    <img id="question-preview" class="preview-image">
                </div>
                
                <div class="form-group">
                    <label for="question_text">Texto da Quest√£o *</label>
                    <textarea class="form-control" id="question_text" name="question_text" 
                              rows="3" required minlength="10" 
                              placeholder="Digite aqui o texto da quest√£o..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="correct_answer">Resposta Correta *</label>
                    <input type="text" class="form-control" id="correct_answer" name="correct_answer" 
                           required minlength="1" placeholder="Digite a resposta correta...">
                </div>
                
                <div class="form-group">
                    <label for="option_a">Resposta Incorreta 1 *</label>
                    <input type="text" class="form-control" id="option_a" name="option_a" 
                           required minlength="1" placeholder="Digite uma resposta incorreta...">
                </div>
                
                <div class="form-group">
                    <label for="option_b">Resposta Incorreta 2 (opcional)</label>
                    <input type="text" class="form-control" id="option_b" name="option_b" 
                           placeholder="Digite outra resposta incorreta...">
                </div>
                
                <div class="form-group">
                    <label for="option_c">Resposta Incorreta 3 (opcional)</label>
                    <input type="text" class="form-control" id="option_c" name="option_c" 
                           placeholder="Digite mais uma resposta incorreta...">
                </div>
                
                <button type="submit" class="btn btn-success">
                    ‚ûï Adicionar Quest√£o
                </button>
            </form>
        </div>
    </div>

    <!-- Bot√µes de Navega√ß√£o -->
    <div class="navigation-buttons">
        <a href="{{ url_for('quiz.manage') }}" class="btn btn-secondary">
            ‚¨ÖÔ∏è Voltar para Gerenciar
        </a>
        
        <div>
            {% if quiz.questions %}
            <a href="{{ url_for('quiz.view', quiz_id=quiz.id) }}" class="btn btn-primary">
                üëÅÔ∏è Visualizar Quiz
            </a>
            {% endif %}
            <button type="button" class="btn btn-success" onclick="finishQuiz()">
                ‚úÖ Finalizar Edi√ß√£o
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<div class="modal fade" id="deleteQuestionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üóëÔ∏è Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta quest√£o?</p>
                <p><strong id="question-to-delete"></strong></p>
                <p><small class="text-muted">Esta a√ß√£o n√£o pode ser desfeita.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" style="display: inline;">
                    <input type="hidden" id="delete-question-id" name="question_id">
                    <button type="submit" class="btn btn-danger" 
                            formaction="{{ url_for('quiz.delete_question', question_id=0) }}"
                            onclick="this.formAction = this.formAction.replace('0', document.getElementById('delete-question-id').value)">
                        üóëÔ∏è Excluir Quest√£o
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Navega√ß√£o entre etapas
function showStep(step) {
    // Remover classe active de todos
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.quiz-content').forEach(c => c.classList.remove('active'));
    
    // Adicionar classe active no selecionado
    document.getElementById('step-' + step).classList.add('active');
    document.getElementById('content-' + step).classList.add('active');
}

// Event listeners para os steps
document.getElementById('step-info').addEventListener('click', () => showStep('info'));
document.getElementById('step-questions').addEventListener('click', () => showStep('questions'));

// Preview de imagens
document.getElementById('quiz_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('quiz-preview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        }
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

document.getElementById('question_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('question-preview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        }
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

// Confirma√ß√£o de exclus√£o de quest√£o
function confirmDeleteQuestion(questionId, questionText) {
    document.getElementById('delete-question-id').value = questionId;
    document.getElementById('question-to-delete').textContent = questionText;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteQuestionModal'));
    modal.show();
}

// Mover quest√£o (placeholder - implementar no backend se necess√°rio)
function moveQuestion(questionId, direction) {
    // Esta funcionalidade pode ser implementada futuramente
    alert('Funcionalidade de reordena√ß√£o ser√° implementada em breve!');
}

// Finalizar edi√ß√£o do quiz
function finishQuiz() {
    const questionsCount = {{ quiz.questions|length }};
    
    if (questionsCount === 0) {
        alert('Adicione pelo menos uma quest√£o antes de finalizar o quiz!');
        showStep('questions');
        return;
    }
    
    if (confirm('Finalizar a edi√ß√£o do quiz? Voc√™ poder√° edit√°-lo novamente depois.')) {
        window.location.href = "{{ url_for('quiz.manage') }}";
    }
}

// Valida√ß√£o do formul√°rio de quest√£o
document.querySelector('.add-question-form form').addEventListener('submit', function(e) {
    const questionText = document.getElementById('question_text').value.trim();
    const correctAnswer = document.getElementById('correct_answer').value.trim();
    const optionA = document.getElementById('option_a').value.trim();
    
    if (questionText.length < 10) {
        alert('O texto da quest√£o deve ter pelo menos 10 caracteres.');
        e.preventDefault();
        return;
    }
    
    if (correctAnswer.length < 1) {
        alert('A resposta correta √© obrigat√≥ria.');
        e.preventDefault();
        return;
    }
    
    if (optionA.length < 1) {
        alert('Pelo menos uma resposta incorreta √© obrigat√≥ria.');
        e.preventDefault();
        return;
    }
    
    // Verificar se a resposta correta n√£o √© igual √†s incorretas
    const answers = [correctAnswer.toLowerCase(), optionA.toLowerCase()];
    const optionB = document.getElementById('option_b').value.trim();
    const optionC = document.getElementById('option_c').value.trim();
    
    if (optionB) answers.push(optionB.toLowerCase());
    if (optionC) answers.push(optionC.toLowerCase());
    
    const uniqueAnswers = [...new Set(answers)];
    if (uniqueAnswers.length !== answers.length) {
        alert('As respostas n√£o podem ser iguais entre si.');
        e.preventDefault();
        return;
    }
});

// Auto-navegar para quest√µes se o quiz j√° tem informa√ß√µes b√°sicas
document.addEventListener('DOMContentLoaded', function() {
    const hasTitle = "{{ quiz.title }}" !== "";
    if (hasTitle && window.location.hash === '#questions') {
        showStep('questions');
    }
});
</script>
{% endblock %}
