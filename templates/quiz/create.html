{% extends "base.html" %}

{% block title %}Criar Quiz - Brainchild{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header com bot√£o voltar melhorado -->
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <h1 class="mb-0 text-primary">
            <i class="bi bi-plus-circle"></i> Criar Novo Quiz
        </h1>
    </div>

    <!-- Progress Bar Melhorado -->
    <div class="progress mb-4" style="height: 8px;">
        <div class="progress-bar bg-primary progress-bar-striped" 
             role="progressbar" 
             id="progressBar" 
             style="width: 33%"></div>
    </div>

    <!-- Stepper Visual -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stepper d-flex justify-content-between align-items-center">
                <div class="step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Informa√ß√µes B√°sicas</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Criar Quest√µes</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Finalizar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel (remov√≠vel em produ√ß√£o) -->
    <div class="alert alert-info mb-4" id="debugPanel" style="display: none;">
        <h6><i class="bi bi-bug"></i> Debug Info:</h6>
        <div id="debugContent"></div>
    </div>

    <!-- Formul√°rio Principal -->
    <form id="quizForm" method="POST" enctype="multipart/form-data">
        {{ csrf_token() if csrf_token }}
        
        <!-- FASE 1: Informa√ß√µes B√°sicas -->
        <div class="step-content" id="stepContent1">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informa√ß√µes do Quiz</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label fw-bold">
                                    <i class="bi bi-pencil"></i> T√≠tulo do Quiz *
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="title" 
                                       name="title" 
                                       required
                                       placeholder="Ex: Hist√≥ria do Brasil - Per√≠odo Colonial">
                                <div class="form-text">Escolha um t√≠tulo claro e descritivo</div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label fw-bold">
                                    <i class="bi bi-text-paragraph"></i> Descri√ß√£o
                                </label>
                                <textarea class="form-control" 
                                          id="description" 
                                          name="description" 
                                          rows="3"
                                          placeholder="Descreva o conte√∫do e objetivos do quiz..."></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="category" class="form-label fw-bold">
                                            <i class="bi bi-tag"></i> Categoria *
                                        </label>
                                        <select class="form-select" id="category" name="category" required>
                                            <option value="">Escolha uma categoria</option>
                                            <option value="matematica">Matem√°tica</option>
                                            <option value="portugues">Portugu√™s</option>
                                            <option value="historia">Hist√≥ria</option>
                                            <option value="geografia">Geografia</option>
                                            <option value="ciencias">Ci√™ncias</option>
                                            <option value="ingles">Ingl√™s</option>
                                            <option value="fisica">F√≠sica</option>
                                            <option value="quimica">Qu√≠mica</option>
                                            <option value="biologia">Biologia</option>
                                            <option value="filosofia">Filosofia</option>
                                            <option value="sociologia">Sociologia</option>
                                            <option value="arte">Arte</option>
                                            <option value="outros">Outros</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="difficulty" class="form-label fw-bold">
                                            <i class="bi bi-speedometer2"></i> Dificuldade *
                                        </label>
                                        <select class="form-select" id="difficulty" name="difficulty" required>
                                            <option value="">Selecione a dificuldade</option>
                                            <option value="facil">üü¢ F√°cil</option>
                                            <option value="medio">üü° M√©dio</option>
                                            <option value="dificil">üî¥ Dif√≠cil</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="time_limit" class="form-label fw-bold">
                                    <i class="bi bi-clock"></i> Tempo Limite (em minutos)
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="time_limit" 
                                       name="time_limit" 
                                       min="1" 
                                       max="180"
                                       placeholder="30">
                                <div class="form-text">Deixe em branco para sem limite de tempo</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="image" class="form-label fw-bold">
                                    <i class="bi bi-image"></i> Imagem do Quiz
                                </label>
                                <div class="image-upload-area border-2 border-dashed border-secondary rounded-3 p-4 text-center">
                                    <input type="file" 
                                           class="form-control d-none" 
                                           id="image" 
                                           name="image" 
                                           accept="image/*">
                                    <div id="imagePreview">
                                        <i class="bi bi-cloud-upload display-4 text-secondary mb-2"></i>
                                        <p class="mb-2">Clique ou arraste uma imagem</p>
                                        <small class="text-muted">PNG, JPG at√© 16MB</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-end mt-4">
                <button type="button" class="btn btn-primary btn-lg" id="nextToQuestions">
                    Pr√≥ximo: Criar Quest√µes <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- FASE 2: Criar Quest√µes -->
        <div class="step-content d-none" id="stepContent2">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-question-circle"></i> Quest√µes do Quiz</h5>
                    <span class="badge bg-light text-success" id="questionsCounter">0 quest√µes</span>
                </div>
                <div class="card-body p-4">
                    <!-- Container das Quest√µes -->
                    <div id="questionsContainer">
                        <!-- Quest√µes ser√£o adicionadas dinamicamente aqui -->
                    </div>
                    
                    <!-- Bot√£o Adicionar Quest√£o -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-outline-success btn-lg" id="addQuestionBtn">
                            <i class="bi bi-plus-circle"></i> Adicionar Quest√£o
                        </button>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary btn-lg" id="backToBasics">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="nextToFinish" disabled>
                    Pr√≥ximo: Finalizar <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- FASE 3: Finalizar -->
        <div class="step-content d-none" id="stepContent3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Revisar e Finalizar</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="text-primary mb-3">üìã Resumo do Quiz</h6>
                            <div id="quizSummary">
                                <!-- Resumo ser√° preenchido via JavaScript -->
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle"></i> Antes de finalizar:</h6>
                                <ul class="mb-0 small">
                                    <li>Revise todas as quest√µes</li>
                                    <li>Verifique as respostas corretas</li>
                                    <li>Confirme as informa√ß√µes b√°sicas</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary btn-lg" id="backToQuestions">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
                <button type="submit" class="btn btn-success btn-lg" id="finishQuiz">
                    <i class="bi bi-check-circle"></i> Criar Quiz
                </button>
            </div>
        </div>
    </form>
</div>

<style>
/* Estilos do Stepper */
.stepper {
    max-width: 600px;
    margin: 0 auto;
}

.step {
    text-align: center;
    flex: 1;
    position: relative;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 8px;
    transition: all 0.3s ease;
}

.step.active .step-circle {
    background-color: #0d6efd;
    color: white;
}

.step.completed .step-circle {
    background-color: #198754;
    color: white;
}

.step-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.step.active .step-label {
    color: #0d6efd;
    font-weight: 600;
}

.step-line {
    height: 2px;
    background-color: #e9ecef;
    margin: 20px 20px 0 20px;
    flex: 1;
}

.step.completed + .step-line {
    background-color: #198754;
}

/* Upload de Imagem */
.image-upload-area {
    cursor: pointer;
    transition: all 0.3s ease;
}

.image-upload-area:hover {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.05);
}

/* Quest√µes */
.question-card {
    border-left: 4px solid #0d6efd;
    margin-bottom: 1.5rem;
}

.question-header {
    background-color: rgba(13, 110, 253, 0.05);
    border-bottom: 1px solid rgba(13, 110, 253, 0.1);
}

.answer-option {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.answer-option:hover {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.answer-option.correct {
    border-color: #198754;
    background-color: rgba(25, 135, 84, 0.05);
}

/* Anima√ß√µes */
.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Loading States */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
class QuizCreator {
    constructor() {
        this.currentStep = 1;
        this.questions = [];
        this.questionCounter = 0;
        this.isSubmitting = false;
        
        // Log inicial para debug
        console.log('üöÄ QuizCreator initialized');
        
        this.initializeEventListeners();
        this.updateUI();
    }

    initializeEventListeners() {
        console.log('üìù Setting up event listeners...');
        
        // Navega√ß√£o entre etapas
        document.getElementById('nextToQuestions')?.addEventListener('click', () => this.goToStep(2));
        document.getElementById('backToBasics')?.addEventListener('click', () => this.goToStep(1));
        document.getElementById('nextToFinish')?.addEventListener('click', () => this.goToStep(3));
        document.getElementById('backToQuestions')?.addEventListener('click', () => this.goToStep(2));
        
        // Adicionar quest√£o
        document.getElementById('addQuestionBtn')?.addEventListener('click', () => this.addQuestion());
        
        // Upload de imagem
        const imageInput = document.getElementById('image');
        const imageUploadArea = document.querySelector('.image-upload-area');
        
        if (imageInput && imageUploadArea) {
            imageUploadArea.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (e) => this.handleImageUpload(e));
        }
        
        // Envio do formul√°rio
        document.getElementById('finishQuiz')?.addEventListener('click', (e) => {
            e.preventDefault();
            this.submitQuiz();
        });
        
        // Event delegation para bot√µes din√¢micos
        document.addEventListener('click', (e) => {
            if (e.target.matches('.delete-question-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const questionNum = parseInt(e.target.dataset.question);
                this.deleteQuestion(questionNum);
            }
            
            if (e.target.matches('.correct-answer-radio')) {
                const questionNum = parseInt(e.target.dataset.question);
                this.setCorrectAnswer(questionNum, e.target.value);
            }
        });
        
        console.log('‚úÖ Event listeners configured');
    }

    goToStep(stepNumber) {
        console.log(`üîÑ Going to step ${stepNumber}`);
        
        // Validar etapa atual antes de prosseguir
        if (stepNumber > this.currentStep && !this.validateCurrentStep()) {
            console.log('‚ùå Step validation failed');
            return;
        }
        
        // Esconder etapa atual
        const currentStepContent = document.getElementById(`stepContent${this.currentStep}`);
        if (currentStepContent) {
            currentStepContent.classList.add('d-none');
        }
        
        // Mostrar nova etapa
        const newStepContent = document.getElementById(`stepContent${stepNumber}`);
        if (newStepContent) {
            newStepContent.classList.remove('d-none');
            newStepContent.classList.add('fade-in');
        }
        
        this.currentStep = stepNumber;
        this.updateStepper();
        this.updateProgressBar();
        
        // A√ß√µes espec√≠ficas por etapa
        if (stepNumber === 3) {
            this.generateSummary();
        }
        
        console.log(`‚úÖ Now on step ${stepNumber}`);
    }

    validateCurrentStep() {
        console.log(`üîç Validating step ${this.currentStep}`);
        
        switch(this.currentStep) {
            case 1:
                const title = document.getElementById('title').value.trim();
                const category = document.getElementById('category').value;
                const difficulty = document.getElementById('difficulty').value;
                
                if (!title || !category || !difficulty) {
                    this.showAlert('Por favor, preencha todos os campos obrigat√≥rios.', 'warning');
                    return false;
                }
                break;
                
            case 2:
                if (this.questions.length === 0) {
                    this.showAlert('Adicione pelo menos uma quest√£o ao quiz.', 'warning');
                    return false;
                }
                
                // Validar se todas as quest√µes t√™m resposta correta
                for (let question of this.questions) {
                    if (!question.correctAnswer) {
                        this.showAlert('Todas as quest√µes devem ter uma resposta correta marcada.', 'warning');
                        return false;
                    }
                    if (!question.text.trim()) {
                        this.showAlert('Todas as quest√µes devem ter texto.', 'warning');
                        return false;
                    }
                    if (question.answers.some(answer => !answer.trim())) {
                        this.showAlert('Todas as alternativas devem ser preenchidas.', 'warning');
                        return false;
                    }
                }
                break;
        }
        
        console.log('‚úÖ Step validation passed');
        return true;
    }

    addQuestion() {
        this.questionCounter++;
        const questionNum = this.questionCounter;
        
        console.log(`‚ûï Adding question #${questionNum}`);
        
        const questionData = {
            id: questionNum,
            text: '',
            answers: ['', '', '', ''],
            correctAnswer: null,
            image: null
        };
        
        this.questions.push(questionData);
        
        const questionHTML = this.createQuestionHTML(questionNum);
        document.getElementById('questionsContainer').insertAdjacentHTML('beforeend', questionHTML);
        
        this.updateQuestionsCounter();
        this.updateNextButton();
        
        // Focar no campo de texto da nova quest√£o
        setTimeout(() => {
            document.getElementById(`question_${questionNum}_text`)?.focus();
        }, 100);
        
        console.log(`‚úÖ Question #${questionNum} added`);
    }

    createQuestionHTML(questionNum) {
        return `
            <div class="question-card card mb-3" data-question="${questionNum}">
                <div class="question-header card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-question-circle"></i> Quest√£o ${questionNum}
                    </h6>
                    <button type="button" class="btn btn-outline-danger btn-sm delete-question-btn" data-question="${questionNum}">
                        <i class="bi bi-trash"></i> Remover
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Pergunta *</label>
                        <textarea class="form-control" 
                                  id="question_${questionNum}_text" 
                                  name="questions[${questionNum}][text]" 
                                  rows="2" 
                                  placeholder="Digite a pergunta aqui..."
                                  required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Alternativas *</label>
                        <div class="row">
                            ${['A', 'B', 'C', 'D'].map((letter, index) => `
                                <div class="col-md-6 mb-2">
                                    <div class="input-group">
                                        <div class="input-group-text">
                                            <input type="radio" 
                                                   name="questions[${questionNum}][correct]" 
                                                   value="${index}" 
                                                   class="correct-answer-radio"
                                                   data-question="${questionNum}"
                                                   title="Marcar como resposta correta">
                                        </div>
                                        <span class="input-group-text fw-bold">${letter}</span>
                                        <input type="text" 
                                               class="form-control" 
                                               name="questions[${questionNum}][answers][${index}]" 
                                               placeholder="Alternativa ${letter}"
                                               required>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            Clique no c√≠rculo ao lado da alternativa para marc√°-la como correta
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Imagem da Quest√£o (opcional)</label>
                        <input type="file" 
                               class="form-control" 
                               name="questions[${questionNum}][image]" 
                               accept="image/*">
                    </div>
                </div>
            </div>
        `;
    }

    deleteQuestion(questionNum) {
        console.log(`üóëÔ∏è Deleting question #${questionNum}`);
        
        if (confirm('Tem certeza que deseja remover esta quest√£o?')) {
            // Remover do array
            this.questions = this.questions.filter(q => q.id !== questionNum);
            
            // Remover do DOM
            const questionElement = document.querySelector(`[data-question="${questionNum}"]`);
            if (questionElement) {
                questionElement.remove();
            }
            
            this.updateQuestionsCounter();
            this.updateNextButton();
            
            console.log(`‚úÖ Question #${questionNum} deleted`);
        }
    }

    setCorrectAnswer(questionNum, answerIndex) {
        console.log(`‚úîÔ∏è Setting correct answer for question #${questionNum}: ${answerIndex}`);
        
        const question = this.questions.find(q => q.id === questionNum);
        if (question) {
            question.correctAnswer = parseInt(answerIndex);
        }
        
        this.updateNextButton();
    }

    handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        console.log(`üñºÔ∏è Image uploaded: ${file.name}`);
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                <p class="mt-2 mb-0 small text-success">
                    <i class="bi bi-check-circle"></i> ${file.name}
                </p>
            `;
        };
        reader.readAsDataURL(file);
    }

    generateSummary() {
        console.log('üìã Generating quiz summary');
        
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const category = document.getElementById('category').selectedOptions[0]?.text || '';
        const difficulty = document.getElementById('difficulty').selectedOptions[0]?.text || '';
        const timeLimit = document.getElementById('time_limit').value;
        
        const summaryHTML = `
            <div class="mb-3">
                <h6 class="text-primary mb-2">üìö ${title}</h6>
                ${description ? `<p class="text-muted mb-2">${description}</p>` : ''}
                <div class="row">
                    <div class="col-md-4">
                        <small class="text-muted d-block">Categoria:</small>
                        <strong>${category}</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Dificuldade:</small>
                        <strong>${difficulty}</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Tempo:</small>
                        <strong>${timeLimit ? timeLimit + ' min' : 'Sem limite'}</strong>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <h6 class="text-success mb-2">
                    <i class="bi bi-question-circle"></i> 
                    ${this.questions.length} Quest√£o(√µes) Criada(s)
                </h6>
                <div class="small text-muted">
                    ${this.questions.map((q, index) => 
                        `${index + 1}. ${q.text || 'Quest√£o ' + (index + 1)}`
                    ).join('<br>')}
                </div>
            </div>
        `;
        
        document.getElementById('quizSummary').innerHTML = summaryHTML;
    }

    async submitQuiz() {
        if (this.isSubmitting) {
            console.log('‚è≥ Already submitting, ignoring...');
            return;
        }
        
        this.isSubmitting = true;
        console.log('üì§ Submitting quiz...');
        
        const submitBtn = document.getElementById('finishQuiz');
        const originalText = submitBtn.innerHTML;
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;
        
        try {
            // Mostrar debug info
            this.updateDebugPanel('Coletando dados do formul√°rio...');
            
            const formData = new FormData(document.getElementById('quizForm'));
            
            // Adicionar dados das quest√µes
            this.questions.forEach((question, index) => {
                const questionData = this.collectQuestionData(question.id);
                if (questionData) {
                    Object.entries(questionData).forEach(([key, value]) => {
                        formData.append(`questions[${index}][${key}]`, value);
                    });
                }
            });
            
            this.updateDebugPanel('Enviando para o servidor...');
            
            // Log dos dados sendo enviados
            console.log('üìã Form data being sent:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}:`, value);
            }
            
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            console.log(`üì° Response status: ${response.status}`);
            
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Success response:', result);
                
                if (result.success) {
                    this.showAlert('Quiz criado com sucesso!', 'success');
                    setTimeout(() => {
                        window.location.href = result.redirect || '/dashboard';
                    }, 2000);
                } else {
                    console.error('‚ùå Server returned error:', result);
                    this.showAlert(result.message || 'Erro ao criar quiz.', 'danger');
                }
            } else {
                const errorText = await response.text();
                console.error('‚ùå HTTP Error:', response.status, errorText);
                this.showAlert(`Erro ${response.status}: ${response.statusText}`, 'danger');
            }
            
        } catch (error) {
            console.error('üí• Submission error:', error);
            this.showAlert('Erro de conex√£o. Tente novamente.', 'danger');
        } finally {
            this.isSubmitting = false;
            submitBtn.classList.remove('btn-loading');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            this.updateDebugPanel('Processo finalizado.');
        }
    }

    collectQuestionData(questionId) {
        console.log(`üìù Collecting data for question #${questionId}`);
        
        const textElement = document.getElementById(`question_${questionId}_text`);
        if (!textElement) {
            console.log(`‚ùå Question #${questionId} not found in DOM`);
            return null;
        }
        
        const text = textElement.value.trim();
        const answers = [];
        let correctAnswer = null;
        
        // Coletar alternativas
        for (let i = 0; i < 4; i++) {
            const answerInput = document.querySelector(`input[name="questions[${questionId}][answers][${i}]"]`);
            answers.push(answerInput ? answerInput.value.trim() : '');
        }
        
        // Encontrar resposta correta
        const correctRadio = document.querySelector(`input[name="questions[${questionId}][correct]"]:checked`);
        if (correctRadio) {
            correctAnswer = parseInt(correctRadio.value);
        }
        
        const questionData = {
            text: text,
            answer_a: answers[0],
            answer_b: answers[1],
            answer_c: answers[2],
            answer_d: answers[3],
            correct_answer: correctAnswer
        };
        
        console.log(`‚úÖ Question #${questionId} data:`, questionData);
        return questionData;
    }

    updateQuestionsCounter() {
        const counter = document.getElementById('questionsCounter');
        if (counter) {
            const count = this.questions.length;
            counter.textContent = `${count} quest√£o${count !== 1 ? '√µes' : ''}`;
        }
    }

    updateNextButton() {
        const nextBtn = document.getElementById('nextToFinish');
        if (nextBtn) {
            const hasQuestions = this.questions.length > 0;
            const allQuestionsValid = this.questions.every(q => q.correctAnswer !== null);
            nextBtn.disabled = !hasQuestions || !allQuestionsValid;
        }
    }

    updateStepper() {
        // Atualizar visual do stepper
        for (let i = 1; i <= 3; i++) {
            const step = document.getElementById(`step-${i}`);
            if (step) {
                step.classList.remove('active', 'completed');
                
                if (i < this.currentStep) {
                    step.classList.add('completed');
                } else if (i === this.currentStep) {
                    step.classList.add('active');
                }
            }
        }
    }

    updateProgressBar() {
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            const percentage = (this.currentStep / 3) * 100;
            progressBar.style.width = `${percentage}%`;
        }
    }

    updateDebugPanel(message) {
        const debugPanel = document.getElementById('debugPanel');
        const debugContent = document.getElementById('debugContent');
        
        if (debugPanel && debugContent) {
            debugPanel.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div class="small">[${timestamp}] ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        
        console.log(`üîç DEBUG: ${message}`);
    }

    showAlert(message, type = 'info') {
        console.log(`üö® Alert (${type}): ${message}`);
        
        // Remover alertas existentes
        const existingAlerts = document.querySelectorAll('.alert-dismissible');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="bi bi-${this.getAlertIcon(type)}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Inserir no topo do container
        const container = document.querySelector('.container');
        if (container) {
            container.insertAdjacentHTML('afterbegin', alertHTML);
            
            // Auto-remover ap√≥s 5 segundos (exceto erros)
            if (type !== 'danger') {
                setTimeout(() => {
                    const alert = container.querySelector('.alert');
                    if (alert) {
                        alert.classList.remove('show');
                        setTimeout(() => alert.remove(), 300);
                    }
                }, 5000);
            }
        }
    }

    getAlertIcon(type) {
        const icons = {
            'success': 'check-circle',
            'danger': 'exclamation-triangle',
            'warning': 'exclamation-circle',
            'info': 'info-circle'
        };
        return icons[type] || 'info-circle';
    }

    updateUI() {
        this.updateStepper();
        this.updateProgressBar();
        this.updateQuestionsCounter();
        this.updateNextButton();
    }
}

// Inicializar quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', () => {
    console.log('üéØ DOM loaded, initializing QuizCreator...');
    window.quizCreator = new QuizCreator();
    console.log('‚úÖ QuizCreator ready!');
});

// Log global para debug
window.addEventListener('error', (e) => {
    console.error('üí• Global error:', e.error);
});

window.addEventListener('unhandledrejection', (e) => {
    console.error('üí• Unhandled promise rejection:', e.reason);
});
</script>

{% endblock %}
