{% extends "base.html" %}

{% block title %}Criar Quiz - Brainchild{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header com bot√£o voltar melhorado -->
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <h1 class="mb-0 text-primary">
            <i class="bi bi-plus-circle"></i> Criar Novo Quiz
        </h1>
    </div>

    <!-- Formul√°rio de Cria√ß√£o do Quiz -->
    <form id="quizForm" method="POST" enctype="multipart/form-data" novalidate>
        {{ csrf_token() if csrf_token }}
        
        <!-- Informa√ß√µes B√°sicas do Quiz -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informa√ß√µes do Quiz</h5>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="title" class="form-label fw-bold">
                                <i class="bi bi-pencil"></i> T√≠tulo do Quiz *
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="title" 
                                   name="title" 
                                   required
                                   placeholder="Ex: Hist√≥ria do Brasil - Per√≠odo Colonial">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label fw-bold">
                                <i class="bi bi-text-paragraph"></i> Descri√ß√£o
                            </label>
                            <textarea class="form-control" 
                                      id="description" 
                                      name="description" 
                                      rows="3"
                                      placeholder="Descreva o conte√∫do e objetivos do quiz..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category" class="form-label fw-bold">
                                        <i class="bi bi-tag"></i> Categoria *
                                    </label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">Escolha uma categoria</option>
                                        <option value="matematica">Matem√°tica</option>
                                        <option value="portugues">Portugu√™s</option>
                                        <option value="historia">Hist√≥ria</option>
                                        <option value="geografia">Geografia</option>
                                        <option value="ciencias">Ci√™ncias</option>
                                        <option value="ingles">Ingl√™s</option>
                                        <option value="fisica">F√≠sica</option>
                                        <option value="quimica">Qu√≠mica</option>
                                        <option value="biologia">Biologia</option>
                                        <option value="filosofia">Filosofia</option>
                                        <option value="sociologia">Sociologia</option>
                                        <option value="arte">Arte</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="difficulty" class="form-label fw-bold">
                                        <i class="bi bi-speedometer2"></i> Dificuldade *
                                    </label>
                                    <select class="form-select" id="difficulty" name="difficulty" required>
                                        <option value="">Selecione a dificuldade</option>
                                        <option value="facil">üü¢ F√°cil</option>
                                        <option value="medio">üü° M√©dio</option>
                                        <option value="dificil">üî¥ Dif√≠cil</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="time_limit" class="form-label fw-bold">
                                <i class="bi bi-clock"></i> Tempo Limite (minutos)
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="time_limit" 
                                   name="time_limit" 
                                   min="1" 
                                   max="180"
                                   placeholder="30">
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="image" class="form-label fw-bold">
                                <i class="bi bi-image"></i> Imagem do Quiz
                            </label>
                            <div class="image-upload-area border-2 border-dashed border-secondary rounded-3 p-4 text-center" style="cursor: pointer;">
                                <input type="file" 
                                       class="form-control d-none" 
                                       id="image" 
                                       name="image" 
                                       accept="image/*">
                                <div id="imagePreview">
                                    <i class="bi bi-cloud-upload display-4 text-secondary mb-2"></i>
                                    <p class="mb-2">Clique para enviar imagem</p>
                                    <small class="text-muted">PNG, JPG at√© 16MB</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quest√µes do Quiz -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> Quest√µes do Quiz</h5>
                <button type="button" class="btn btn-outline-light btn-sm" id="addQuestionBtn">
                    <i class="bi bi-plus-circle"></i> Adicionar Quest√£o
                </button>
            </div>
            <div class="card-body p-4">
                <!-- Container onde as quest√µes ser√£o adicionadas -->
                <div id="questionsContainer">
                    <!-- Quest√µes aparecer√£o aqui -->
                </div>
                
                <div class="text-center" id="noQuestionsMessage">
                    <div class="py-4">
                        <i class="bi bi-question-circle display-4 text-muted mb-3"></i>
                        <p class="text-muted">Nenhuma quest√£o adicionada ainda.</p>
                        <button type="button" class="btn btn-success" onclick="addQuestion()">
                            <i class="bi bi-plus-circle"></i> Criar Primeira Quest√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√£o Criar Quiz -->
        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg px-5" id="createQuizBtn">
                <i class="bi bi-check-circle"></i> Criar Quiz
            </button>
        </div>
    </form>
</div>

<!-- Debug Panel (oculto por padr√£o) -->
<div class="alert alert-info mt-3" id="debugPanel" style="display: none;">
    <h6><i class="bi bi-bug"></i> Debug Info:</h6>
    <div id="debugContent"></div>
</div>

<style>
.image-upload-area {
    transition: all 0.3s ease;
}

.image-upload-area:hover {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.05);
}

.question-card {
    border-left: 4px solid #0d6efd;
    margin-bottom: 1.5rem;
}

.answer-option {
    margin-bottom: 10px;
}

.answer-option .form-control {
    border-radius: 8px;
}

.correct-answer-indicator {
    color: #198754;
    font-weight: bold;
}

.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
// Debug ativo para encontrar problemas
let debugMode = true;
let questionCount = 0;
let isSubmitting = false;

function debugLog(message, data = null) {
    if (debugMode) {
        console.log(`üîç [DEBUG] ${message}`, data || '');
        updateDebugPanel(message);
    }
}

function updateDebugPanel(message) {
    const debugPanel = document.getElementById('debugPanel');
    const debugContent = document.getElementById('debugContent');
    
    if (debugPanel && debugContent) {
        debugPanel.style.display = 'block';
        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `<div class="small">[${timestamp}] ${message}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
    }
}

function addQuestion() {
    questionCount++;
    debugLog(`Adding question #${questionCount}`);
    
    const questionsContainer = document.getElementById('questionsContainer');
    const noQuestionsMessage = document.getElementById('noQuestionsMessage');
    
    // Esconder mensagem "nenhuma quest√£o"
    if (noQuestionsMessage) {
        noQuestionsMessage.style.display = 'none';
    }
    
    const questionHTML = `
        <div class="question-card card mb-4 fade-in" data-question="${questionCount}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-primary">
                    <i class="bi bi-question-circle"></i> Quest√£o ${questionCount}
                </h6>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeQuestion(${questionCount})">
                    <i class="bi bi-trash"></i> Remover
                </button>
            </div>
            <div class="card-body">
                <!-- Texto da Quest√£o -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Pergunta *</label>
                    <textarea class="form-control" 
                              name="question_${questionCount}_text" 
                              id="question_${questionCount}_text"
                              rows="3" 
                              placeholder="Digite sua pergunta aqui..."
                              required></textarea>
                </div>
                
                <!-- Alternativas -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Alternativas *</label>
                    
                    <div class="answer-option">
                        <div class="input-group mb-2">
                            <div class="input-group-text">
                                <input type="radio" name="question_${questionCount}_correct" value="0" required>
                            </div>
                            <span class="input-group-text fw-bold">A</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_a" placeholder="Alternativa A" required>
                        </div>
                    </div>
                    
                    <div class="answer-option">
                        <div class="input-group mb-2">
                            <div class="input-group-text">
                                <input type="radio" name="question_${questionCount}_correct" value="1" required>
                            </div>
                            <span class="input-group-text fw-bold">B</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_b" placeholder="Alternativa B" required>
                        </div>
                    </div>
                    
                    <div class="answer-option">
                        <div class="input-group mb-2">
                            <div class="input-group-text">
                                <input type="radio" name="question_${questionCount}_correct" value="2" required>
                            </div>
                            <span class="input-group-text fw-bold">C</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_c" placeholder="Alternativa C" required>
                        </div>
                    </div>
                    
                    <div class="answer-option">
                        <div class="input-group mb-2">
                            <div class="input-group-text">
                                <input type="radio" name="question_${questionCount}_correct" value="3" required>
                            </div>
                            <span class="input-group-text fw-bold">D</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_d" placeholder="Alternativa D" required>
                        </div>
                    </div>
                    
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> 
                        Marque a alternativa correta clicando no c√≠rculo ao lado
                    </small>
                </div>
                
                <!-- Imagem da Quest√£o -->
                <div class="mb-3">
                    <label class="form-label">Imagem da Quest√£o (opcional)</label>
                    <input type="file" class="form-control" name="question_${questionCount}_image" accept="image/*">
                </div>
            </div>
        </div>
    `;
    
    questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
    
    // Focar no campo de texto da nova quest√£o
    setTimeout(() => {
        const textField = document.getElementById(`question_${questionCount}_text`);
        if (textField) {
            textField.focus();
        }
    }, 100);
    
    debugLog(`Question #${questionCount} added successfully`);
}

function removeQuestion(questionNum) {
    debugLog(`Removing question #${questionNum}`);
    
    if (confirm('Tem certeza que deseja remover esta quest√£o?')) {
        const questionElement = document.querySelector(`[data-question="${questionNum}"]`);
        if (questionElement) {
            questionElement.remove();
            debugLog(`Question #${questionNum} removed`);
            
            // Mostrar mensagem se n√£o h√° mais quest√µes
            const remainingQuestions = document.querySelectorAll('.question-card');
            if (remainingQuestions.length === 0) {
                const noQuestionsMessage = document.getElementById('noQuestionsMessage');
                if (noQuestionsMessage) {
                    noQuestionsMessage.style.display = 'block';
                }
            }
        }
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    debugLog('DOM loaded, initializing event listeners');
    
    // Bot√£o adicionar quest√£o
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    if (addQuestionBtn) {
        addQuestionBtn.addEventListener('click', addQuestion);
    }
    
    // Upload de imagem
    const imageInput = document.getElementById('image');
    const imageUploadArea = document.querySelector('.image-upload-area');
    
    if (imageInput && imageUploadArea) {
        imageUploadArea.addEventListener('click', () => imageInput.click());
        
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                debugLog(`Image selected: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    if (preview) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                            <p class="mt-2 mb-0 small text-success">
                                <i class="bi bi-check-circle"></i> ${file.name}
                            </p>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Envio do formul√°rio
    const form = document.getElementById('quizForm');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }
    
    debugLog('Event listeners configured successfully');
});

async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (isSubmitting) {
        debugLog('Already submitting, ignoring...');
        return;
    }
    
    isSubmitting = true;
    debugLog('Starting form submission');
    
    const submitBtn = document.getElementById('createQuizBtn');
    const originalText = submitBtn.innerHTML;
    
    // Loading state
    submitBtn.classList.add('btn-loading');
    submitBtn.disabled = true;
    
    try {
        // Validar formul√°rio
        if (!validateForm()) {
            debugLog('Form validation failed');
            return;
        }
        
        // Coletar dados
        const formData = collectFormData();
        if (!formData) {
            debugLog('Failed to collect form data');
            return;
        }
        
        debugLog('Sending form data to server...');
        
        // Enviar para servidor
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        debugLog(`Server response status: ${response.status}`);
        
        if (response.ok) {
            const result = await response.text();
            debugLog('Server response received', result.substring(0, 200) + '...');
            
            try {
                const jsonResult = JSON.parse(result);
                if (jsonResult.success) {
                    showAlert('Quiz criado com sucesso!', 'success');
                    setTimeout(() => {
                        window.location.href = jsonResult.redirect || '/dashboard';
                    }, 2000);
                } else {
                    showAlert(jsonResult.message || 'Erro ao criar quiz', 'danger');
                }
            } catch (jsonError) {
                // Se n√£o for JSON, assumir que foi criado com sucesso
                debugLog('Non-JSON response, assuming success');
                showAlert('Quiz criado com sucesso!', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        } else {
            const errorText = await response.text();
            debugLog(`Server error: ${response.status}`, errorText);
            showAlert(`Erro ${response.status}: ${response.statusText}`, 'danger');
        }
        
    } catch (error) {
        debugLog('Submission error', error);
        console.error('Submission error:', error);
        showAlert('Erro de conex√£o. Tente novamente.', 'danger');
    } finally {
        isSubmitting = false;
        submitBtn.classList.remove('btn-loading');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function validateForm() {
    debugLog('Validating form...');
    
    // Validar campos b√°sicos
    const title = document.getElementById('title').value.trim();
    const category = document.getElementById('category').value;
    const difficulty = document.getElementById('difficulty').value;
    
    if (!title) {
        showAlert('T√≠tulo √© obrigat√≥rio', 'warning');
        return false;
    }
    
    if (!category) {
        showAlert('Categoria √© obrigat√≥ria', 'warning');
        return false;
    }
    
    if (!difficulty) {
        showAlert('Dificuldade √© obrigat√≥ria', 'warning');
        return false;
    }
    
    // Validar quest√µes
    const questions = document.querySelectorAll('.question-card');
    if (questions.length === 0) {
        showAlert('Adicione pelo menos uma quest√£o', 'warning');
        return false;
    }
    
    debugLog(`Found ${questions.length} questions to validate`);
    
    for (let i = 0; i < questions.length; i++) {
        const questionElement = questions[i];
        const questionNum = questionElement.dataset.question;
        
        debugLog(`Validating question #${questionNum}`);
        
        // Validar texto da quest√£o
        const textField = questionElement.querySelector(`[name="question_${questionNum}_text"]`);
        if (!textField || !textField.value.trim()) {
            showAlert(`Quest√£o ${parseInt(i) + 1}: Texto da pergunta √© obrigat√≥rio`, 'warning');
            return false;
        }
        
        // Validar alternativas
        const options = ['a', 'b', 'c', 'd'];
        for (let option of options) {
            const optionField = questionElement.querySelector(`[name="question_${questionNum}_option_${option}"]`);
            if (!optionField || !optionField.value.trim()) {
                showAlert(`Quest√£o ${parseInt(i) + 1}: Todas as alternativas devem ser preenchidas`, 'warning');
                return false;
            }
        }
        
        // Validar resposta correta
        const correctAnswer = questionElement.querySelector(`input[name="question_${questionNum}_correct"]:checked`);
        if (!correctAnswer) {
            showAlert(`Quest√£o ${parseInt(i) + 1}: Selecione a resposta correta`, 'warning');
            return false;
        }
        
        debugLog(`Question #${questionNum} validation passed`);
    }
    
    debugLog('Form validation successful');
    return true;
}

function collectFormData() {
    debugLog('Collecting form data...');
    
    const formData = new FormData();
    
    // Dados b√°sicos
    const basicFields = ['title', 'description', 'category', 'difficulty', 'time_limit'];
    basicFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field && field.value) {
            formData.append(fieldName, field.value);
            debugLog(`Added basic field: ${fieldName} = ${field.value}`);
        }
    });
    
    // Imagem principal
    const imageField = document.getElementById('image');
    if (imageField && imageField.files[0]) {
        formData.append('image', imageField.files[0]);
        debugLog(`Added main image: ${imageField.files[0].name}`);
    }
    
    // Quest√µes
    const questions = document.querySelectorAll('.question-card');
    debugLog(`Collecting data from ${questions.length} questions`);
    
    questions.forEach((questionElement, index) => {
        const questionNum = questionElement.dataset.question;
        debugLog(`Collecting data for question #${questionNum} (index ${index})`);
        
        // Texto da quest√£o
        const textField = questionElement.querySelector(`[name="question_${questionNum}_text"]`);
        if (textField) {
            formData.append(`questions[${index}][text]`, textField.value);
        }
        
        // Alternativas
        const options = ['a', 'b', 'c', 'd'];
        options.forEach(option => {
            const optionField = questionElement.querySelector(`[name="question_${questionNum}_option_${option}"]`);
            if (optionField) {
                formData.append(`questions[${index}][${option}]`, optionField.value);
            }
        });
        
        // Resposta correta
        const correctAnswer = questionElement.querySelector(`input[name="question_${questionNum}_correct"]:checked`);
        if (correctAnswer) {
            formData.append(`questions[${index}][correct]`, correctAnswer.value);
        }
        
        // Imagem da quest√£o
        const imageField = questionElement.querySelector(`[name="question_${questionNum}_image"]`);
        if (imageField && imageField.files[0]) {
            formData.append(`questions[${index}][image]`, imageField.files[0]);
            debugLog(`Added image for question #${questionNum}`);
        }
    });
    
    debugLog('Form data collection complete');
    
    // Debug: mostrar todos os dados coletados
    for (let [key, value] of formData.entries()) {
        debugLog(`FormData: ${key} = ${value instanceof File ? `[File: ${value.name}]` : value}`);
    }
    
    return formData;
}

function showAlert(message, type = 'info') {
    debugLog(`Showing alert (${type}): ${message}`);
    
    // Remover alertas existentes
    const existingAlerts = document.querySelectorAll('.alert-dismissible');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHTML);
        
        // Auto-remover ap√≥s 5 segundos (exceto erros)
        if (type !== 'danger') {
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 300);
                }
            }, 5000);
        }
    }
}

// Global error handling
window.addEventListener('error', (e) => {
    debugLog(`Global error: ${e.error?.message || e.message}`);
    console.error('Global error:', e.error);
});

window.addEventListener('unhandledrejection', (e) => {
    debugLog(`Unhandled promise rejection: ${e.reason}`);
    console.error('Unhandled promise rejection:', e.reason);
});
</script>

{% endblock %}
